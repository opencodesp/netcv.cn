<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" href="network.png">
    <title>NetCV.CN</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript">
        marked.setOptions({
            gfm: true,
            breaks: true
        })
    </script>
    <style type="text/css">
        * {
            padding: 0;margin: 0;list-style: none;
            font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #606c71;    
        }
        .tips {
            display: none;
            position: fixed;
            top: 80px;left: 0;right: 0;
            width: 220px;
            text-align: center;
            margin:auto;
            color: #fff;
        }
        header {
            background-color: #159957;
            background-image: linear-gradient(120deg, #155799, #159957);
            padding: 10px;
            text-align: center;
            height: 330px;
        }
        header .logo {font-size: 60px;color: #fff;font-weight: 600;margin-top: 120px;}
        .container {padding: 20px;max-width: 1024px;margin: 0 auto;}
        @media screen and (max-width: 820px){
            .container {padding: 10px;max-width: 100%;}
            header {height: 52px;}
            header .logo {font-size: 32px;margin-top: 10px;line-height: 32px;text-align: left;}
        }
        .container li {margin: 10px 0;}
        .title {font-weight: bold;font-size: 22px;margin: 5px 0;color: #159957;}
        .content {line-height: 1.6;font-size: 14px;word-break: break-word;}
        .content img {max-width: 100%;max-height: 360px;}
        .content h1 {font-size: 22px;color: #159957;}
        .content h2 {font-size: 18px;border-bottom: 1px solid #eee;line-height: 32px;padding: 5px 0;margin: 10px 0;}
        .content blockquote {padding: 2px 10px;margin: 10px 0;color: #222;background: #f8f8f8;border-left: 3px solid #159957;}

        .btn {
            display: inline-block;
            margin-bottom: 1rem;
            color: rgba(255,255,255,0.7);
            background-color: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            border-style: solid;
            border-width: 1px;
            border-radius: 0.3rem;
            transition: color 0.2s, background-color 0.2s, border-color 0.2s;
        }
    </style>
</head>
<body>
    <div class="tips"></div>
    <header>
        <div class="logo">NetCV.cn</div>
    </header>
    <div class="container"></div>
    <script type="text/javascript">
        const RAW_DATA_KEY = 'raw-data'
        const RAW_DATA_VALID_SECONDS = 10

        // 1. Loadding Tips
        let tips = document.querySelector('.tips')
        tips.style.display = 'block'
        tips.innerHTML = 'Loadding Articles ...'

        // 2. Load and Render
        loadForRender()

        
        function loadForRender()  {
            let rawData = localStorage.getItem('raw-data')
            if(rawData) {
                let dataJson = JSON.parse(rawData)
                if(new Date().getTime() - dataJson.uptime > 1000 * RAW_DATA_VALID_SECONDS) {
                    fetchRawData()
                    return       
                }
                renderByRawData(dataJson.rawData)
                return
            }
            fetchRawData()
        }

        function fetchRawData() {
            fetch(new Request('https://api.github.com/repos/opencodesp/netcv.cn/issues', {
                method: 'GET'
            })).
            then(resp => resp.json()).
            then(json => {
                localStorage.setItem('raw-data', JSON.stringify({
                    uptime: new Date().getTime(),
                    rawData: json
                }))
                renderByRawData(json)
            }).
            catch(e => onError(e))
        }

        // 3. Render Raw Data
        function renderByRawData(json) {
            // Close Loadding Tips
            tips.innerHTML = ''
            tips.style.display = 'none'
            // Render UI
            renderIssues(json)
        }

        // 4. On Error
        function onError(e) {
            // Render Cahce
            let rawData = localStorage.getItem(RAW_DATA_KEY)
            if(rawData) {
                tips.innerHTML = 'Loaded from cache.'
                renderIssues(JSON.parse(rawData).rawData)
                return
            }
            // Show Reload Tips
            tips.innerHTML = e + '. Please try again.'
        }

        // 4. Render Issues
        function renderIssues(json) {
            let container = document.querySelector('.container')
            let ul = document.createElement('ul')
            container.appendChild(ul)
            for(let i in json) {
                let title = document.createElement('div')
                title.className = 'title'
                title.innerHTML = json[i].title

                let content = document.createElement('div')
                content.className = 'content'
                content.innerHTML = marked(json[i].body)

                let li = document.createElement('li')

                li.appendChild(title)
                li.appendChild(content)

                ul.appendChild(li)
            }
            renderIssuesOver()
        }

        function viewImage(img) {
            img.style.maxHeight = 'none'
            img.onclick = function() {
                noViewImage(img)
            }
        }

        function noViewImage(img) {
            img.style.maxHeight = '360px'
            img.onclick = function() {
                viewImage(img)
            }
        }

        function renderIssuesOver() {
            document.querySelectorAll('.content img').forEach(img => {
                img.onclick = function () {
                    viewImage(img)
                }
            })
        }

    </script>
</body>
</html>